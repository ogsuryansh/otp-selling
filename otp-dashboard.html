<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OTP Number Dashboard - Phone Number Management</title>
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <h1 class="text-xl font-bold text-gray-900">ðŸ“± OTP Number Dashboard</h1>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="refreshBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh
                    </button>
                    <button id="settingsBtn" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-cog mr-2"></i>Settings
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Quick Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-blue-500 rounded-md flex items-center justify-center">
                            <i class="fas fa-phone text-white"></i>
                        </div>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">Active Orders</p>
                        <p id="activeOrders" class="text-2xl font-semibold text-gray-900">-</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-green-500 rounded-md flex items-center justify-center">
                            <i class="fas fa-check-circle text-white"></i>
                        </div>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">Completed</p>
                        <p id="completedOrders" class="text-2xl font-semibold text-gray-900">-</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-yellow-500 rounded-md flex items-center justify-center">
                            <i class="fas fa-clock text-white"></i>
                        </div>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">Pending</p>
                        <p id="pendingOrders" class="text-2xl font-semibold text-gray-900">-</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-purple-500 rounded-md flex items-center justify-center">
                            <i class="fas fa-wallet text-white"></i>
                        </div>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">Balance</p>
                        <p id="providerBalance" class="text-2xl font-semibold text-gray-900">-</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Tabs -->
        <div class="bg-white rounded-lg shadow">
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-8 px-6">
                    <button class="tab-btn active py-4 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600" data-tab="buy">
                        <i class="fas fa-shopping-cart mr-2"></i>Buy Number
                    </button>
                    <button class="tab-btn py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="orders">
                        <i class="fas fa-list mr-2"></i>My Orders
                    </button>
                    <button class="tab-btn py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="status">
                        <i class="fas fa-chart-bar mr-2"></i>Status
                    </button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div class="p-6">
                <!-- Buy Number Tab -->
                <div id="buy-tab" class="tab-content active">
                    <div class="max-w-2xl mx-auto">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6">Buy Phone Number for OTP</h2>
                        
                        <form id="buyNumberForm" class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Provider</label>
                                    <select id="provider" name="provider" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="5sim">5sim.net</option>
                                        <option value="sms-activate">SMS-Activate</option>
                                        <option value="smshub">SMSHub</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Country</label>
                                    <select id="country" name="country" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Select Country</option>
                                    </select>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Service</label>
                                    <select id="product" name="product" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Select Service</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Operator (Optional)</label>
                                    <select id="operator" name="operator" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="any">Any Operator</option>
                                    </select>
                                </div>
                            </div>

                            <div class="flex items-center justify-between">
                                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-md font-medium">
                                    <i class="fas fa-shopping-cart mr-2"></i>Buy Number
                                </button>
                                <div id="priceInfo" class="text-right">
                                    <p class="text-sm text-gray-500">Price: <span id="price" class="font-semibold text-gray-900">-</span></p>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Orders Tab -->
                <div id="orders-tab" class="tab-content hidden">
                    <div class="space-y-6">
                        <div class="flex justify-between items-center">
                            <h2 class="text-2xl font-bold text-gray-900">My Orders</h2>
                            <div class="flex space-x-2">
                                <select id="orderStatusFilter" class="px-3 py-2 border border-gray-300 rounded-md text-sm">
                                    <option value="">All Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="sms_received">SMS Received</option>
                                    <option value="completed">Completed</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                                <select id="orderProviderFilter" class="px-3 py-2 border border-gray-300 rounded-md text-sm">
                                    <option value="">All Providers</option>
                                    <option value="5sim">5sim.net</option>
                                    <option value="sms-activate">SMS-Activate</option>
                                    <option value="smshub">SMSHub</option>
                                </select>
                            </div>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Order ID</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phone</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Service</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="ordersTableBody" class="bg-white divide-y divide-gray-200">
                                    <!-- Orders will be populated here -->
                                </tbody>
                            </table>
                        </div>

                        <div id="ordersPagination" class="flex items-center justify-between">
                            <!-- Pagination will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Status Tab -->
                <div id="status-tab" class="tab-content hidden">
                    <div class="space-y-6">
                        <h2 class="text-2xl font-bold text-gray-900">Service Status</h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="bg-white rounded-lg shadow p-6">
                                <h3 class="text-lg font-medium text-gray-900 mb-4">5sim.net</h3>
                                <div id="status5sim" class="space-y-3">
                                    <div class="flex justify-between">
                                        <span class="text-sm text-gray-500">Status:</span>
                                        <span class="text-sm font-medium text-green-600">Operational</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm text-gray-500">Balance:</span>
                                        <span id="balance5sim" class="text-sm font-medium">-</span>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-white rounded-lg shadow p-6">
                                <h3 class="text-lg font-medium text-gray-900 mb-4">SMS-Activate</h3>
                                <div id="statusSmsActivate" class="space-y-3">
                                    <div class="flex justify-between">
                                        <span class="text-sm text-gray-500">Status:</span>
                                        <span class="text-sm font-medium text-yellow-600">Configure API Key</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm text-gray-500">Balance:</span>
                                        <span id="balanceSmsActivate" class="text-sm font-medium">-</span>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-white rounded-lg shadow p-6">
                                <h3 class="text-lg font-medium text-gray-900 mb-4">SMSHub</h3>
                                <div id="statusSmshub" class="space-y-3">
                                    <div class="flex justify-between">
                                        <span class="text-sm text-gray-500">Status:</span>
                                        <span class="text-sm font-medium text-yellow-600">Configure API Key</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm text-gray-500">Balance:</span>
                                        <span id="balanceSmshub" class="text-sm font-medium">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div id="orderModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Order Details</h3>
                    <button id="closeModal" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="modalContent" class="space-y-4">
                    <!-- Order details will be populated here -->
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button id="checkSmsBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm">
                        <i class="fas fa-sync-alt mr-2"></i>Check SMS
                    </button>
                    <button id="finishOrderBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm">
                        <i class="fas fa-check mr-2"></i>Finish
                    </button>
                    <button id="cancelOrderBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm">
                        <i class="fas fa-times mr-2"></i>Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
        <div class="animate-spin rounded-full h-32 w-32 border-b-2 border-blue-600"></div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed top-4 right-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg border-l-4 p-4 max-w-sm">
            <div class="flex items-center">
                <div id="toastIcon" class="flex-shrink-0 w-5 h-5 mr-3"></div>
                <div>
                    <p id="toastMessage" class="text-sm font-medium text-gray-900"></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUserId = '12345'; // This should come from authentication
        let currentOrder = null;
        let currentPage = 1;
        let ordersPerPage = 10;

        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeTabs();
            loadInitialData();
            setupEventListeners();
        });

        // Tab management
        function initializeTabs() {
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');

            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetTab = btn.dataset.tab;
                    
                    // Update active tab button
                    tabBtns.forEach(b => b.classList.remove('active', 'border-blue-500', 'text-blue-600'));
                    btn.classList.add('active', 'border-blue-500', 'text-blue-600');
                    
                    // Show target tab content
                    tabContents.forEach(content => {
                        content.classList.add('hidden');
                        if (content.id === `${targetTab}-tab`) {
                            content.classList.remove('hidden');
                        }
                    });

                    // Load data for the selected tab
                    if (targetTab === 'orders') {
                        loadUserOrders();
                    } else if (targetTab === 'status') {
                        loadServiceStatus();
                    }
                });
            });
        }

        // Event listeners
        function setupEventListeners() {
            // Form submission
            document.getElementById('buyNumberForm').addEventListener('submit', handleBuyNumber);
            
            // Provider change
            document.getElementById('provider').addEventListener('change', handleProviderChange);
            
            // Country change
            document.getElementById('country').addEventListener('change', handleCountryChange);
            
            // Filters
            document.getElementById('orderStatusFilter').addEventListener('change', loadUserOrders);
            document.getElementById('orderProviderFilter').addEventListener('change', loadUserOrders);
            
            // Refresh button
            document.getElementById('refreshBtn').addEventListener('click', loadInitialData);
            
            // Modal close
            document.getElementById('closeModal').addEventListener('click', closeOrderModal);
            
            // Order actions
            document.getElementById('checkSmsBtn').addEventListener('click', checkSMS);
            document.getElementById('finishOrderBtn').addEventListener('click', finishOrder);
            document.getElementById('cancelOrderBtn').addEventListener('click', cancelOrder);
        }

        // Load initial data
        async function loadInitialData() {
            showLoading(true);
            try {
                await Promise.all([
                    loadCountries(),
                    loadServiceStatus(),
                    loadUserOrders()
                ]);
            } catch (error) {
                showToast('Error loading initial data', 'error');
            } finally {
                showLoading(false);
            }
        }

        // Load countries for selected provider
        async function loadCountries() {
            try {
                const provider = document.getElementById('provider').value;
                const response = await fetch(`/api/otp-number/countries?provider=${provider}`);
                const data = await response.json();
                
                if (data.success) {
                    const countrySelect = document.getElementById('country');
                    countrySelect.innerHTML = '<option value="">Select Country</option>';
                    
                    data.data.countries.forEach(country => {
                        const option = document.createElement('option');
                        option.value = country.code;
                        option.textContent = `${country.flag} ${country.name} (${country.count})`;
                        countrySelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading countries:', error);
            }
        }

        // Load products for selected country
        async function loadProducts() {
            try {
                const provider = document.getElementById('provider').value;
                const country = document.getElementById('country').value;
                
                if (!country) return;
                
                const response = await fetch(`/api/otp-number/products?provider=${provider}&country=${country}`);
                const data = await response.json();
                
                if (data.success) {
                    const productSelect = document.getElementById('product');
                    productSelect.innerHTML = '<option value="">Select Service</option>';
                    
                    data.data.products.forEach(product => {
                        const option = document.createElement('option');
                        option.value = product.service;
                        option.textContent = `${product.name} - $${product.price}`;
                        option.dataset.price = product.price;
                        productSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }

        // Handle provider change
        function handleProviderChange() {
            document.getElementById('country').innerHTML = '<option value="">Select Country</option>';
            document.getElementById('product').innerHTML = '<option value="">Select Service</option>';
            document.getElementById('price').textContent = '-';
            loadCountries();
        }

        // Handle country change
        function handleCountryChange() {
            document.getElementById('product').innerHTML = '<option value="">Select Service</option>';
            document.getElementById('price').textContent = '-';
            loadProducts();
        }

        // Handle product selection
        document.getElementById('product').addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const price = selectedOption.dataset.price || '-';
            document.getElementById('price').textContent = price === '-' ? '-' : `$${price}`;
        });

        // Handle buy number form submission
        async function handleBuyNumber(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = {
                provider: formData.get('provider'),
                country: formData.get('country'),
                product: formData.get('product'),
                operator: formData.get('operator')
            };
            
            if (!data.country || !data.product) {
                showToast('Please select country and service', 'error');
                return;
            }
            
            showLoading(true);
            try {
                const response = await fetch('/api/otp-number/buy', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-user-id': currentUserId
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast(result.data.message, 'success');
                    e.target.reset();
                    document.getElementById('price').textContent = '-';
                    loadUserOrders(); // Refresh orders
                } else {
                    showToast(result.message || 'Failed to buy number', 'error');
                }
            } catch (error) {
                showToast('Error buying number', 'error');
            } finally {
                showLoading(false);
            }
        }

        // Load user orders
        async function loadUserOrders() {
            try {
                const statusFilter = document.getElementById('orderStatusFilter').value;
                const providerFilter = document.getElementById('orderProviderFilter').value;
                
                let url = `/api/otp-number/orders?limit=${ordersPerPage}&page=${currentPage}`;
                if (statusFilter) url += `&status=${statusFilter}`;
                if (providerFilter) url += `&provider=${providerFilter}`;
                
                const response = await fetch(url, {
                    headers: {
                        'x-user-id': currentUserId
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    displayOrders(data.data.orders);
                    displayPagination(data.data.pagination);
                    updateOrderStats(data.data.orders);
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                showToast('Error loading orders', 'error');
            }
        }

        // Display orders in table
        function displayOrders(orders) {
            const tbody = document.getElementById('ordersTableBody');
            tbody.innerHTML = '';
            
            if (orders.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                            No orders found
                        </td>
                    </tr>
                `;
                return;
            }
            
            orders.forEach(order => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                const statusClass = getStatusClass(order.status);
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        ${order.order_id}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${order.phone}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${order.product}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${statusClass}">
                            ${order.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${new Date(order.created_at).toLocaleDateString()}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="viewOrder('${order.order_id}')" class="text-blue-600 hover:text-blue-900 mr-3">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // Get status class for styling
        function getStatusClass(status) {
            switch (status) {
                case 'pending': return 'bg-yellow-100 text-yellow-800';
                case 'sms_received': return 'bg-blue-100 text-blue-800';
                case 'completed': return 'bg-green-100 text-green-800';
                case 'cancelled': return 'bg-red-100 text-red-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        // Display pagination
        function displayPagination(pagination) {
            const paginationDiv = document.getElementById('ordersPagination');
            
            if (pagination.totalPages <= 1) {
                paginationDiv.innerHTML = '';
                return;
            }
            
            let html = `
                <div class="flex items-center justify-between">
                    <div class="text-sm text-gray-700">
                        Showing ${((pagination.page - 1) * pagination.limit) + 1} to ${Math.min(pagination.page * pagination.limit, pagination.total)} of ${pagination.total} results
                    </div>
                    <div class="flex space-x-2">
            `;
            
            // Previous button
            if (pagination.page > 1) {
                html += `<button onclick="changePage(${pagination.page - 1})" class="px-3 py-2 border border-gray-300 rounded-md text-sm hover:bg-gray-50">Previous</button>`;
            }
            
            // Page numbers
            for (let i = 1; i <= pagination.totalPages; i++) {
                if (i === pagination.page) {
                    html += `<span class="px-3 py-2 bg-blue-600 text-white rounded-md text-sm">${i}</span>`;
                } else {
                    html += `<button onclick="changePage(${i})" class="px-3 py-2 border border-gray-300 rounded-md text-sm hover:bg-gray-50">${i}</button>`;
                }
            }
            
            // Next button
            if (pagination.page < pagination.totalPages) {
                html += `<button onclick="changePage(${pagination.page + 1})" class="px-3 py-2 border border-gray-300 rounded-md text-sm hover:bg-gray-50">Next</button>`;
            }
            
            html += '</div></div>';
            paginationDiv.innerHTML = html;
        }

        // Change page
        function changePage(page) {
            currentPage = page;
            loadUserOrders();
        }

        // Update order statistics
        function updateOrderStats(orders) {
            const stats = {
                active: orders.filter(o => o.status === 'pending' || o.status === 'sms_received').length,
                completed: orders.filter(o => o.status === 'completed').length,
                pending: orders.filter(o => o.status === 'pending').length
            };
            
            document.getElementById('activeOrders').textContent = stats.active;
            document.getElementById('completedOrders').textContent = stats.completed;
            document.getElementById('pendingOrders').textContent = stats.pending;
        }

        // Load service status
        async function loadServiceStatus() {
            try {
                const providers = ['5sim', 'sms-activate', 'smshub'];
                
                for (const provider of providers) {
                    try {
                        const response = await fetch(`/api/otp-number/status?provider=${provider}`);
                        const data = await response.json();
                        
                        if (data.success) {
                            updateProviderStatus(provider, data.data);
                        }
                    } catch (error) {
                        console.error(`Error loading status for ${provider}:`, error);
                    }
                }
            } catch (error) {
                console.error('Error loading service status:', error);
            }
        }

        // Update provider status display
        function updateProviderStatus(provider, data) {
            const balanceElement = document.getElementById(`balance${provider.charAt(0).toUpperCase() + provider.slice(1)}`);
            if (balanceElement) {
                balanceElement.textContent = `${data.balance} ${data.currency}`;
            }
            
            // Update overall balance if it's the default provider
            if (provider === '5sim') {
                document.getElementById('providerBalance').textContent = `${data.balance} ${data.currency}`;
            }
        }

        // View order details
        async function viewOrder(orderId) {
            try {
                const response = await fetch(`/api/otp-number/orders/${orderId}`, {
                    headers: {
                        'x-user-id': currentUserId
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentOrder = data.data.order;
                    displayOrderModal(currentOrder);
                }
            } catch (error) {
                console.error('Error loading order:', error);
                showToast('Error loading order details', 'error');
            }
        }

        // Display order modal
        function displayOrderModal(order) {
            const modal = document.getElementById('orderModal');
            const content = document.getElementById('modalContent');
            
            content.innerHTML = `
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <span class="font-medium text-gray-700">Order ID:</span>
                        <p class="text-gray-900">${order.order_id}</p>
                    </div>
                    <div>
                        <span class="font-medium text-gray-700">Phone:</span>
                        <p class="text-gray-900">${order.phone}</p>
                    </div>
                    <div>
                        <span class="font-medium text-gray-700">Service:</span>
                        <p class="text-gray-900">${order.product}</p>
                    </div>
                    <div>
                        <span class="font-medium text-gray-700">Country:</span>
                        <p class="text-gray-900">${order.country}</p>
                    </div>
                    <div>
                        <span class="font-medium text-gray-700">Status:</span>
                        <p class="text-gray-900">${order.status}</p>
                    </div>
                    <div>
                        <span class="font-medium text-gray-700">Created:</span>
                        <p class="text-gray-900">${new Date(order.created_at).toLocaleString()}</p>
                    </div>
                </div>
                ${order.sms && order.sms.length > 0 ? `
                    <div class="mt-4">
                        <span class="font-medium text-gray-700">SMS Messages:</span>
                        <div class="mt-2 space-y-2">
                            ${order.sms.map(sms => `
                                <div class="bg-gray-50 p-3 rounded">
                                    <p class="text-sm text-gray-900">${sms.text || 'SMS received'}</p>
                                    <p class="text-xs text-gray-500">${new Date(sms.date).toLocaleString()}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
            `;
            
            // Show/hide action buttons based on status
            const checkSmsBtn = document.getElementById('checkSmsBtn');
            const finishOrderBtn = document.getElementById('finishOrderBtn');
            const cancelOrderBtn = document.getElementById('cancelOrderBtn');
            
            checkSmsBtn.style.display = order.status === 'pending' ? 'inline-block' : 'none';
            finishOrderBtn.style.display = order.status === 'sms_received' ? 'inline-block' : 'none';
            cancelOrderBtn.style.display = order.status === 'pending' ? 'inline-block' : 'none';
            
            modal.classList.remove('hidden');
        }

        // Close order modal
        function closeOrderModal() {
            document.getElementById('orderModal').classList.add('hidden');
            currentOrder = null;
        }

        // Check SMS
        async function checkSMS() {
            if (!currentOrder) return;
            
            try {
                const response = await fetch(`/api/otp-number/check/${currentOrder.order_id}?provider=${currentOrder.provider}`);
                const data = await response.json();
                
                if (data.success) {
                    showToast(data.data.message, 'success');
                    closeOrderModal();
                    loadUserOrders(); // Refresh orders
                } else {
                    showToast(data.message || 'Failed to check SMS', 'error');
                }
            } catch (error) {
                showToast('Error checking SMS', 'error');
            }
        }

        // Finish order
        async function finishOrder() {
            if (!currentOrder) return;
            
            try {
                const response = await fetch(`/api/otp-number/finish/${currentOrder.order_id}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-user-id': currentUserId
                    },
                    body: JSON.stringify({
                        provider: currentOrder.provider
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast(data.data.message, 'success');
                    closeOrderModal();
                    loadUserOrders(); // Refresh orders
                } else {
                    showToast(data.message || 'Failed to finish order', 'error');
                }
            } catch (error) {
                showToast('Error finishing order', 'error');
            }
        }

        // Cancel order
        async function cancelOrder() {
            if (!currentOrder) return;
            
            if (!confirm('Are you sure you want to cancel this order?')) return;
            
            try {
                const response = await fetch(`/api/otp-number/cancel/${currentOrder.order_id}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-user-id': currentUserId
                    },
                    body: JSON.stringify({
                        provider: currentOrder.provider
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast(data.data.message, 'success');
                    closeOrderModal();
                    loadUserOrders(); // Refresh orders
                } else {
                    showToast(data.message || 'Failed to cancel order', 'error');
                }
            } catch (error) {
                showToast('Error cancelling order', 'error');
            }
        }

        // Utility functions
        function showLoading(show) {
            const spinner = document.getElementById('loadingSpinner');
            if (show) {
                spinner.classList.remove('hidden');
            } else {
                spinner.classList.add('hidden');
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            const toastIcon = document.getElementById('toastIcon');
            
            toastMessage.textContent = message;
            
            // Set icon and colors based on type
            let iconClass = '';
            let borderColor = '';
            
            switch (type) {
                case 'success':
                    iconClass = 'fas fa-check-circle text-green-500';
                    borderColor = 'border-green-500';
                    break;
                case 'error':
                    iconClass = 'fas fa-exclamation-circle text-red-500';
                    borderColor = 'border-red-500';
                    break;
                case 'warning':
                    iconClass = 'fas fa-exclamation-triangle text-yellow-500';
                    borderColor = 'border-yellow-500';
                    break;
                default:
                    iconClass = 'fas fa-info-circle text-blue-500';
                    borderColor = 'border-blue-500';
            }
            
            toastIcon.className = iconClass;
            toast.querySelector('.border-l-4').className = `border-l-4 ${borderColor}`;
            
            toast.classList.remove('hidden');
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 5000);
        }
    </script>
    
    <!-- Main JavaScript -->
    <script src="assets/js/main.js"></script>
</body>
</html>
