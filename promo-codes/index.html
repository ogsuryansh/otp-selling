<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Promo Codes - OTP Bot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#667eea',
                        secondary: '#764ba2',
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="../assets/css/main.css">
</head>
<body class="gradient-bg min-h-screen text-gray-800">
    <div class="container mx-auto px-4 py-6 max-w-7xl">
        <!-- Header -->
        <div class="glass rounded-2xl p-6 mb-6 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-white mb-2">üé´ Promo Codes</h1>
            <p class="text-gray-200 mb-4">Manage promotional codes and discounts</p>
            
            <!-- Navigation -->
            <div class="flex flex-wrap justify-center gap-3">
                <a href="../" class="glass px-4 py-2 rounded-lg text-white hover:bg-white/20 transition-all duration-300 text-sm font-medium">
                    üè† Home
                </a>
                <a href="../dashboard/" class="glass px-4 py-2 rounded-lg text-white hover:bg-white/20 transition-all duration-300 text-sm font-medium">
                    üìä Dashboard
                </a>
                <a href="../admin/" class="glass px-4 py-2 rounded-lg text-white hover:bg-white/20 transition-all duration-300 text-sm font-medium">
                    ‚öôÔ∏è Admin
                </a>
            </div>
        </div>

        <!-- Main Content -->
        <div class="glass rounded-xl p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-white">Promo Code Management</h2>
                <button onclick="openAddPromoModal()" class="btn-primary">‚ûï Add Promo Code</button>
            </div>

            <!-- Search and Filters -->
            <div class="flex flex-col md:flex-row gap-4 mb-6">
                <input type="text" id="promoSearch" placeholder="Search promo codes..." class="form-input flex-1">
                <select id="statusFilter" class="form-select md:w-48">
                    <option value="">All Status</option>
                    <option value="active">Active</option>
                    <option value="expired">Expired</option>
                    <option value="used">Used</option>
                </select>
                <button onclick="refreshPromoCodes()" class="btn-secondary">üîÑ Refresh</button>
            </div>

            <!-- Promo Codes Table -->
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Code</th>
                            <th>Discount</th>
                            <th>Uses</th>
                            <th>Status</th>
                            <th>Expires</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="promoCodesTable">
                        <tr>
                            <td colspan="7" class="text-center p-8 text-gray-400">
                                <div class="spinner"></div>
                                <p class="mt-2">Loading promo codes...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Statistics -->
        <div class="glass rounded-xl p-6 mt-6">
            <h3 class="text-xl font-semibold text-white mb-4">üìä Promo Code Statistics</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="stat-card">
                    <div class="text-2xl mb-2">üé´</div>
                    <div class="text-2xl font-bold text-white" id="totalPromos">-</div>
                    <div class="text-gray-300 text-sm">Total Codes</div>
                </div>
                
                <div class="stat-card">
                    <div class="text-2xl mb-2">‚úÖ</div>
                    <div class="text-2xl font-bold text-white" id="activePromos">-</div>
                    <div class="text-gray-300 text-sm">Active Codes</div>
                </div>
                
                <div class="stat-card">
                    <div class="text-2xl mb-2">üí∞</div>
                    <div class="text-2xl font-bold text-white" id="totalDiscount">-</div>
                    <div class="text-gray-300 text-sm">Total Discount</div>
                </div>
                
                <div class="stat-card">
                    <div class="text-2xl mb-2">üë•</div>
                    <div class="text-2xl font-bold text-white" id="totalUses">-</div>
                    <div class="text-gray-300 text-sm">Total Uses</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Promo Code Modal -->
    <div id="addPromoModal" class="modal">
        <div class="modal-content mx-4 my-8 max-w-md w-full fade-in">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">Add Promo Code</h3>
                    <button onclick="closeModal('addPromoModal')" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                
                <form id="addPromoForm" onsubmit="handleAddPromo(event)" data-validate>
                    <div class="space-y-4">
                        <div>
                            <label class="text-gray-700 text-sm font-medium">Promo Code</label>
                            <input type="text" id="promoCode" required class="form-input" placeholder="e.g., WELCOME20">
                        </div>
                        <div>
                            <label class="text-gray-700 text-sm font-medium">Discount (%)</label>
                            <input type="number" id="promoDiscount" required min="1" max="100" class="form-input" placeholder="20">
                        </div>
                        <div>
                            <label class="text-gray-700 text-sm font-medium">Max Uses</label>
                            <input type="number" id="promoMaxUses" required min="1" class="form-input" placeholder="100">
                        </div>
                        <div>
                            <label class="text-gray-700 text-sm font-medium">Expires At</label>
                            <input type="datetime-local" id="promoExpires" class="form-input">
                        </div>
                        <div>
                            <label class="text-gray-700 text-sm font-medium">Description</label>
                            <textarea id="promoDescription" class="form-textarea" placeholder="Optional description"></textarea>
                        </div>
                    </div>
                    
                    <div class="flex gap-3 mt-6">
                        <button type="submit" class="btn-primary flex-1">Add Promo Code</button>
                        <button type="button" onclick="closeModal('addPromoModal')" class="btn-secondary flex-1">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Promo Code Modal -->
    <div id="editPromoModal" class="modal">
        <div class="modal-content mx-4 my-8 max-w-md w-full fade-in">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">Edit Promo Code</h3>
                    <button onclick="closeModal('editPromoModal')" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                
                <form id="editPromoForm" onsubmit="handleEditPromo(event)" data-validate>
                    <input type="hidden" id="editPromoId">
                    <div class="space-y-4">
                        <div>
                            <label class="text-gray-700 text-sm font-medium">Promo Code</label>
                            <input type="text" id="editPromoCode" required class="form-input">
                        </div>
                        <div>
                            <label class="text-gray-700 text-sm font-medium">Discount (%)</label>
                            <input type="number" id="editPromoDiscount" required min="1" max="100" class="form-input">
                        </div>
                        <div>
                            <label class="text-gray-700 text-sm font-medium">Max Uses</label>
                            <input type="number" id="editPromoMaxUses" required min="1" class="form-input">
                        </div>
                        <div>
                            <label class="text-gray-700 text-sm font-medium">Expires At</label>
                            <input type="datetime-local" id="editPromoExpires" class="form-input">
                        </div>
                        <div>
                            <label class="text-gray-700 text-sm font-medium">Description</label>
                            <textarea id="editPromoDescription" class="form-textarea"></textarea>
                        </div>
                    </div>
                    
                    <div class="flex gap-3 mt-6">
                        <button type="submit" class="btn-primary flex-1">Update Promo Code</button>
                        <button type="button" onclick="closeModal('editPromoModal')" class="btn-secondary flex-1">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="../assets/js/main.js"></script>
    <script>
        // Promo codes specific functionality
        let promoCodes = [];
        let editingPromoId = null;

        // Load promo codes on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadPromoCodes();
            setupSearchAndFilters();
        });

        // Load promo codes
        async function loadPromoCodes() {
            try {
                const response = await OTPUtils.apiRequest('/api/promo-codes');
                promoCodes = response;
                updatePromoCodesTable();
                updatePromoStats();
            } catch (error) {
                console.error('Error loading promo codes:', error);
                OTPUtils.showError('Failed to load promo codes');
            }
        }

        // Update promo codes table
        function updatePromoCodesTable() {
            const tbody = document.getElementById('promoCodesTable');
            
            if (promoCodes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center p-8 text-gray-400">No promo codes found</td></tr>';
                return;
            }

            tbody.innerHTML = promoCodes.map(promo => `
                <tr>
                    <td class="font-mono">${promo.code}</td>
                    <td>${promo.discount}%</td>
                    <td>${promo.uses}/${promo.maxUses}</td>
                    <td>
                        <span class="status-${getPromoStatus(promo)} px-2 py-1 rounded text-xs">
                            ${getPromoStatus(promo)}
                        </span>
                    </td>
                    <td>${promo.expiresAt ? OTPUtils.formatDate(promo.expiresAt) : 'Never'}</td>
                    <td>${OTPUtils.formatDate(promo.createdAt)}</td>
                    <td>
                        <div class="flex gap-2">
                            <button onclick="editPromo('${promo._id}')" class="btn-secondary text-xs">Edit</button>
                            <button onclick="copyPromoCode('${promo.code}')" class="btn-secondary text-xs">Copy</button>
                            <button onclick="deletePromo('${promo._id}')" class="btn-danger text-xs">Delete</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Get promo status
        function getPromoStatus(promo) {
            if (promo.uses >= promo.maxUses) return 'used';
            if (promo.expiresAt && new Date(promo.expiresAt) < new Date()) return 'expired';
            return 'active';
        }

        // Update promo statistics
        function updatePromoStats() {
            const totalPromos = promoCodes.length;
            const activePromos = promoCodes.filter(p => getPromoStatus(p) === 'active').length;
            const totalDiscount = promoCodes.reduce((sum, promo) => sum + (promo.discount * promo.uses), 0);
            const totalUses = promoCodes.reduce((sum, promo) => sum + promo.uses, 0);

            document.getElementById('totalPromos').textContent = totalPromos;
            document.getElementById('activePromos').textContent = activePromos;
            document.getElementById('totalDiscount').textContent = `$${totalDiscount}`;
            document.getElementById('totalUses').textContent = totalUses;
        }

        // Setup search and filters
        function setupSearchAndFilters() {
            const searchInput = document.getElementById('promoSearch');
            const statusFilter = document.getElementById('statusFilter');

            const debouncedSearch = OTPUtils.debounce(() => {
                filterPromoCodes();
            }, 300);

            searchInput.addEventListener('input', debouncedSearch);
            statusFilter.addEventListener('change', filterPromoCodes);
        }

        // Filter promo codes
        function filterPromoCodes() {
            const searchTerm = document.getElementById('promoSearch').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;

            const filtered = promoCodes.filter(promo => {
                const matchesSearch = promo.code.toLowerCase().includes(searchTerm) ||
                                    (promo.description && promo.description.toLowerCase().includes(searchTerm));
                
                const matchesStatus = !statusFilter || getPromoStatus(promo) === statusFilter;
                
                return matchesSearch && matchesStatus;
            });

            updatePromoCodesTableWithData(filtered);
        }

        // Update table with filtered data
        function updatePromoCodesTableWithData(data) {
            const tbody = document.getElementById('promoCodesTable');
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center p-8 text-gray-400">No promo codes found</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(promo => `
                <tr>
                    <td class="font-mono">${promo.code}</td>
                    <td>${promo.discount}%</td>
                    <td>${promo.uses}/${promo.maxUses}</td>
                    <td>
                        <span class="status-${getPromoStatus(promo)} px-2 py-1 rounded text-xs">
                            ${getPromoStatus(promo)}
                        </span>
                    </td>
                    <td>${promo.expiresAt ? OTPUtils.formatDate(promo.expiresAt) : 'Never'}</td>
                    <td>${OTPUtils.formatDate(promo.createdAt)}</td>
                    <td>
                        <div class="flex gap-2">
                            <button onclick="editPromo('${promo._id}')" class="btn-secondary text-xs">Edit</button>
                            <button onclick="copyPromoCode('${promo.code}')" class="btn-secondary text-xs">Copy</button>
                            <button onclick="deletePromo('${promo._id}')" class="btn-danger text-xs">Delete</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Add promo code
        async function handleAddPromo(event) {
            event.preventDefault();
            
            const promoData = {
                code: document.getElementById('promoCode').value,
                discount: parseInt(document.getElementById('promoDiscount').value),
                maxUses: parseInt(document.getElementById('promoMaxUses').value),
                expiresAt: document.getElementById('promoExpires').value || null,
                description: document.getElementById('promoDescription').value
            };

            try {
                await OTPUtils.apiRequest('/api/promo-codes', {
                    method: 'POST',
                    body: JSON.stringify(promoData)
                });

                OTPUtils.closeModal('addPromoModal');
                document.getElementById('addPromoForm').reset();
                loadPromoCodes();
                OTPUtils.showSuccess('Promo code added successfully!');
            } catch (error) {
                console.error('Error adding promo code:', error);
                OTPUtils.showError('Failed to add promo code');
            }
        }

        // Edit promo code
        function editPromo(promoId) {
            const promo = promoCodes.find(p => p._id === promoId);
            if (!promo) return;

            editingPromoId = promoId;
            
            document.getElementById('editPromoId').value = promo._id;
            document.getElementById('editPromoCode').value = promo.code;
            document.getElementById('editPromoDiscount').value = promo.discount;
            document.getElementById('editPromoMaxUses').value = promo.maxUses;
            document.getElementById('editPromoExpires').value = promo.expiresAt ? promo.expiresAt.slice(0, 16) : '';
            document.getElementById('editPromoDescription').value = promo.description || '';

            OTPUtils.openModal('editPromoModal');
        }

        // Handle edit promo
        async function handleEditPromo(event) {
            event.preventDefault();
            
            const promoData = {
                code: document.getElementById('editPromoCode').value,
                discount: parseInt(document.getElementById('editPromoDiscount').value),
                maxUses: parseInt(document.getElementById('editPromoMaxUses').value),
                expiresAt: document.getElementById('editPromoExpires').value || null,
                description: document.getElementById('editPromoDescription').value
            };

            try {
                await OTPUtils.apiRequest(`/api/promo-codes/${editingPromoId}`, {
                    method: 'PUT',
                    body: JSON.stringify(promoData)
                });

                OTPUtils.closeModal('editPromoModal');
                loadPromoCodes();
                OTPUtils.showSuccess('Promo code updated successfully!');
            } catch (error) {
                console.error('Error updating promo code:', error);
                OTPUtils.showError('Failed to update promo code');
            }
        }

        // Delete promo code
        async function deletePromo(promoId) {
            if (!confirm('Are you sure you want to delete this promo code? This action cannot be undone.')) {
                return;
            }

            try {
                await OTPUtils.apiRequest(`/api/promo-codes/${promoId}`, {
                    method: 'DELETE'
                });

                loadPromoCodes();
                OTPUtils.showSuccess('Promo code deleted successfully!');
            } catch (error) {
                console.error('Error deleting promo code:', error);
                OTPUtils.showError('Failed to delete promo code');
            }
        }

        // Copy promo code
        function copyPromoCode(code) {
            OTPUtils.copyToClipboard(code);
        }

        // Refresh promo codes
        function refreshPromoCodes() {
            loadPromoCodes();
        }

        // Modal functions
        function openAddPromoModal() {
            OTPUtils.openModal('addPromoModal');
        }
    </script>
</body>
</html>
