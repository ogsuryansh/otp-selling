<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transactions</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#667eea',
                        secondary: '#764ba2',
                    }
                }
            }
        }
    </script>
    <style>
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen text-gray-800">
    <div class="container mx-auto px-4 py-6 max-w-7xl">
        <!-- Header -->
        <div class="glass rounded-2xl p-6 mb-6 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-white mb-2">💳 Transactions</h1>
            <p class="text-gray-200 mb-4">View and manage transaction history</p>
            
            <!-- Navigation -->
            <div class="flex flex-wrap justify-center gap-3">
                <a href="/" class="glass px-4 py-2 rounded-lg text-white hover:bg-white/20 transition-all duration-300 text-sm font-medium">
                    🏠 Home
                </a>
                <a href="/users" class="glass px-4 py-2 rounded-lg text-white hover:bg-white/20 transition-all duration-300 text-sm font-medium">
                    👥 Users
                </a>
                <a href="/admin" class="glass px-4 py-2 rounded-lg text-white hover:bg-white/20 transition-all duration-300 text-sm font-medium">
                    ⚙️ Admin
                </a>
                <a href="/servers" class="glass px-4 py-2 rounded-lg text-white hover:bg-white/20 transition-all duration-300 text-sm font-medium">
                    🖥️ Servers
                </a>
            </div>
        </div>

        <!-- Filters -->
        <div class="glass rounded-xl p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                <div>
                    <label class="block text-white text-sm font-medium mb-2">Search</label>
                    <input type="text" id="searchInput" class="w-full px-4 py-2 rounded-lg bg-white/10 text-white placeholder-gray-300 border border-white/20 focus:outline-none focus:border-white/40 text-sm" placeholder="Search transactions...">
                </div>
                <div>
                    <label class="block text-white text-sm font-medium mb-2">Type</label>
                    <select id="typeFilter" class="w-full px-4 py-2 rounded-lg bg-white/10 text-white border border-white/20 focus:outline-none focus:border-white/40 text-sm">
                        <option value="">All Types</option>
                        <option value="admin_action">Admin Action</option>
                        <option value="purchase">Purchase</option>
                        <option value="refund">Refund</option>
                    </select>
                </div>
                <div>
                    <label class="block text-white text-sm font-medium mb-2">User ID</label>
                    <input type="number" id="userIdFilter" class="w-full px-4 py-2 rounded-lg bg-white/10 text-white placeholder-gray-300 border border-white/20 focus:outline-none focus:border-white/40 text-sm" placeholder="Filter by user ID">
                </div>
                <div>
                    <label class="block text-white text-sm font-medium mb-2">Date</label>
                    <input type="date" id="dateFilter" class="w-full px-4 py-2 rounded-lg bg-white/10 text-white border border-white/20 focus:outline-none focus:border-white/40 text-sm">
                </div>
            </div>
            <div class="flex flex-wrap gap-3">
                <button onclick="applyFilters()" class="glass px-4 py-2 rounded-lg text-white hover:bg-white/20 transition-all duration-300 text-sm font-medium">
                    🔍 Apply Filters
                </button>
                <button onclick="clearFilters()" class="glass px-4 py-2 rounded-lg text-white hover:bg-white/20 transition-all duration-300 text-sm font-medium">
                    🗑️ Clear
                </button>
                <button onclick="loadTransactions()" class="glass px-4 py-2 rounded-lg text-white hover:bg-white/20 transition-all duration-300 text-sm font-medium">
                    🔄 Refresh
                </button>
            </div>
        </div>

        <!-- Transaction Count -->
        <div class="glass rounded-xl p-4 mb-6">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-semibold text-white">Transaction History</h2>
                <span class="text-gray-300 text-sm"><span id="transactionCount">0</span> transactions found</span>
            </div>
        </div>

        <!-- Loading and Error Messages -->
        <div id="loadingMessage" class="glass rounded-xl p-8 text-center mb-6">
            <div class="text-gray-300">Loading transactions...</div>
        </div>

        <div id="errorMessage" class="glass rounded-xl p-6 text-center mb-6 bg-red-500/20 border border-red-500/30" style="display: none;">
            <div class="text-red-300"></div>
        </div>

        <!-- Transactions Table -->
        <div class="glass rounded-xl p-6 overflow-x-auto">
            <table class="w-full text-sm" id="transactionsTable" style="display: none;">
                <thead>
                    <tr class="border-b border-white/20">
                        <th class="text-left py-3 px-4 text-white font-semibold">Type</th>
                        <th class="text-left py-3 px-4 text-white font-semibold">Amount</th>
                        <th class="text-left py-3 px-4 text-white font-semibold">User ID</th>
                        <th class="text-left py-3 px-4 text-white font-semibold">Description</th>
                        <th class="text-left py-3 px-4 text-white font-semibold">Balance Before</th>
                        <th class="text-left py-3 px-4 text-white font-semibold">Balance After</th>
                        <th class="text-left py-3 px-4 text-white font-semibold">Timestamp</th>
                    </tr>
                </thead>
                <tbody id="transactionsTableBody" class="text-gray-300">
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="glass rounded-xl p-4 mt-6" id="pagination" style="display: none;">
            <div class="flex justify-center items-center gap-4">
                <button onclick="previousPage()" id="prevBtn" class="glass px-4 py-2 rounded-lg text-white hover:bg-white/20 transition-all duration-300 text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed">
                    ← Previous
                </button>
                <span id="pageInfo" class="text-white text-sm">Page 1 of 1</span>
                <button onclick="nextPage()" id="nextBtn" class="glass px-4 py-2 rounded-lg text-white hover:bg-white/20 transition-all duration-300 text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed">
                    Next →
                </button>
            </div>
        </div>
    </div>

    <script>
        let allTransactions = [];
        let filteredTransactions = [];
        let currentPage = 1;
        const transactionsPerPage = 20;

        // Load transactions
        async function loadTransactions() {
            const loadingMessage = document.getElementById('loadingMessage');
            const errorMessage = document.getElementById('errorMessage');
            const transactionsTable = document.getElementById('transactionsTable');

            loadingMessage.style.display = 'block';
            errorMessage.style.display = 'none';
            transactionsTable.style.display = 'none';

            try {
                const response = await fetch('/api/transactions');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                allTransactions = await response.json();
                applyFilters();
                
                loadingMessage.style.display = 'none';
                transactionsTable.style.display = 'table';
            } catch (error) {
                console.error('Error loading transactions:', error);
                loadingMessage.style.display = 'none';
                errorMessage.style.display = 'block';
                errorMessage.querySelector('div').textContent = `Error loading transactions: ${error.message}`;
            }
        }

        // Apply filters
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const typeFilter = document.getElementById('typeFilter').value;
            const userIdFilter = document.getElementById('userIdFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;

            filteredTransactions = allTransactions.filter(transaction => {
                // Search filter
                if (searchTerm && !transaction.description.toLowerCase().includes(searchTerm)) {
                    return false;
                }

                // Type filter
                if (typeFilter && transaction.type !== typeFilter) {
                    return false;
                }

                // User ID filter
                if (userIdFilter && transaction.user_id.toString() !== userIdFilter) {
                    return false;
                }

                // Date filter
                if (dateFilter) {
                    const transactionDate = new Date(transaction.timestamp).toISOString().split('T')[0];
                    if (transactionDate !== dateFilter) {
                        return false;
                    }
                }

                return true;
            });

            // Sort by timestamp (newest first)
            filteredTransactions.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            currentPage = 1;
            displayTransactions();
            updatePagination();
        }

        // Clear filters
        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('typeFilter').value = '';
            document.getElementById('userIdFilter').value = '';
            document.getElementById('dateFilter').value = '';
            applyFilters();
        }

        // Display transactions
        function displayTransactions() {
            const transactionsTableBody = document.getElementById('transactionsTableBody');
            const transactionCount = document.getElementById('transactionCount');
            
            transactionCount.textContent = filteredTransactions.length;

            const startIndex = (currentPage - 1) * transactionsPerPage;
            const endIndex = startIndex + transactionsPerPage;
            const pageTransactions = filteredTransactions.slice(startIndex, endIndex);

            transactionsTableBody.innerHTML = '';

            pageTransactions.forEach(transaction => {
                const row = document.createElement('tr');
                row.className = 'border-b border-white/10 hover:bg-white/5 transition-colors';
                
                const amount = parseFloat(transaction.amount);
                const amountClass = amount >= 0 ? 'text-green-400' : 'text-red-400';
                const amountSign = amount >= 0 ? '+' : '';
                
                const typeClass = transaction.type === 'admin_action' ? 'bg-blue-500/20 text-blue-300' : 
                                transaction.type === 'purchase' ? 'bg-green-500/20 text-green-300' : 
                                'bg-red-500/20 text-red-300';
                
                row.innerHTML = `
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${typeClass}">
                            ${transaction.type.replace('_', ' ')}
                        </span>
                    </td>
                    <td class="py-3 px-4 font-semibold ${amountClass}">
                        ${amountSign}${amount.toFixed(2)} 💎
                    </td>
                    <td class="py-3 px-4">${transaction.user_id}</td>
                    <td class="py-3 px-4">${transaction.description}</td>
                    <td class="py-3 px-4 text-sm">${(transaction.balance_before || 0).toFixed(2)} 💎</td>
                    <td class="py-3 px-4 text-sm">${(transaction.balance_after || 0).toFixed(2)} 💎</td>
                    <td class="py-3 px-4 text-sm">${formatDate(transaction.timestamp)}</td>
                `;
                transactionsTableBody.appendChild(row);
            });
        }

        // Update pagination
        function updatePagination() {
            const pagination = document.getElementById('pagination');
            const pageInfo = document.getElementById('pageInfo');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            const totalPages = Math.ceil(filteredTransactions.length / transactionsPerPage);
            
            if (totalPages <= 1) {
                pagination.style.display = 'none';
                return;
            }

            pagination.style.display = 'block';
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;
        }

        // Navigation functions
        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                displayTransactions();
                updatePagination();
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(filteredTransactions.length / transactionsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                displayTransactions();
                updatePagination();
            }
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) {
                return 'Unknown';
            }
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
            } catch (error) {
                return dateString;
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('searchInput').addEventListener('input', applyFilters);
            document.getElementById('typeFilter').addEventListener('change', applyFilters);
            document.getElementById('userIdFilter').addEventListener('input', applyFilters);
            document.getElementById('dateFilter').addEventListener('change', applyFilters);
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadTransactions();
            setupEventListeners();
        });
    </script>
</body>
</html>
